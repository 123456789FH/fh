<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù‚Ø±Ø£ Ø§Ù„ÙƒÙ„Ù…Ø© â€” Ø¨Ø·Ø§Ù‚Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© (ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ + ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f5f7ff;
      --ink:#101828;
      --accent:#0ea5e9;
      --accent-2:#22c55e;
      --surface:#ffffff;
      --muted:#667085;
      --ring:#bae6fd;
      --shadow: 0 10px 25px rgba(2,8,23,.08);
      --rounded: 1.25rem;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans Arabic', Tahoma, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 600px at 80% -20%, #dbeafe 0%, transparent 70%),
                  radial-gradient(900px 500px at -10% 110%, #dcfce7 0%, transparent 70%),
                  var(--bg);
    }
    a{color:var(--accent)}
    .container{max-width:980px;margin:0 auto;padding:24px}
    header{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;margin-bottom:20px
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, #38bdf8, #22c55e);
      box-shadow: var(--shadow); display:grid;place-items:center;color:#fff;font-weight:900
    }
    .card{
      background:var(--surface);
      border-radius:var(--rounded);
      padding:20px;
      box-shadow:var(--shadow);
      border:1px solid #eff6ff;
    }
    .home-grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:720px){ .home-grid{grid-template-columns:repeat(3, 1fr)} }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:.6rem;
      padding:12px 16px;border-radius:14px;border:1px solid #e5e7eb;
      background:#fff;color:var(--ink);text-decoration:none;font-weight:700;
      box-shadow:var(--shadow);cursor:pointer;transition:all .15s ease
    }
    .btn:hover{transform:translateY(-1px);}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .btn-primary{background:linear-gradient(180deg,#38bdf8,#0ea5e9);color:#fff;border-color:transparent}
    .btn-green{background:linear-gradient(180deg,#34d399,#22c55e);color:#073b1a;border-color:transparent}
    .btn-ghost{background:transparent;border-color:#dbeafe}
    .tag{display:inline-block;font-size:.85rem;background:#eff6ff;color:#075985;border:1px solid #e0f2fe;border-radius:999px;padding:2px 10px;margin-inline:4px}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .hidden{display:none !important}
    .center{text-align:center}
    .title{font-size:clamp(1.6rem,3vw,2.2rem);margin:0}
    .subtitle{margin:0;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:.5rem;
      padding:8px 12px;border-radius:999px;background:#fff;border:1px solid #e5e7eb;box-shadow:var(--shadow)
    }
    .view{display:none}
    .view.active{display:block}
    .toolbar{display:flex;justify-content:space-between;gap:10px;align-items:center;margin:8px 0 14px}
    .status{font-weight:700}
    .progress{
      height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden
    }
    .progress > span{
      display:block;height:100%;background:linear-gradient(90deg,#38bdf8,#22c55e)
    }
    .word{
      font-size:clamp(2.4rem,5vw,3.8rem);margin:0 0 8px 0;letter-spacing:.5px
    }
    .seg{font-size:1.2rem;color:#0f766e;background:#ecfeff;border:1px dashed #a5f3fc;border-radius:14px;padding:10px 12px;display:inline-flex;gap:.65rem;flex-wrap:wrap}
    .sentence{font-size:1.2rem;margin:12px auto;color:#334155;background:#f8fafc;border:1px solid #e2e8f0;border-radius:14px;padding:12px;display:inline-flex;align-items:center;gap:10px}
    .controls{display:flex;justify-content:center;gap:10px;margin:14px 0 0}
    .controls .btn{min-width:120px}
    .inline-btn{border:none;background:#eef2ff;color:#3730a3;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
    .muted{color:#64748b}
    .sep{height:1px;background:#eef2ff;margin:12px 0}
    .kdraw{border:2px dashed #c7d2fe;border-radius:16px;background:#fafaff;padding:10px}
    .audioBox{border:2px dashed #bbf7d0;background:#f0fdf4}
    canvas{background:#fff;border-radius:12px;display:block;width:100%;height:220px;border:1px solid #e5e7eb; touch-action:none;}
    .typing{width:100%;height:220px;border:1px solid #e5e7eb;border-radius:12px;padding:16px;
            font-size:2rem;line-height:2.6rem;text-align:center;background:#fff}
    footer{margin-top:24px;color:#64748b;font-size:.95rem;text-align:center}
    .chip{display:inline-flex;align-items:center;border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:6px 10px;gap:.5rem}
    .chip input{margin:0}
    .grid-2{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:820px){.grid-2{grid-template-columns:1fr 1fr}}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #eef2ff;padding:8px 6px;text-align:center}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field select,.field textarea{
      padding:10px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-family:inherit
    }
    .hint{font-size:.92rem;color:#6b7280}
    .note{background:#fffbeb;border:1px solid #fde68a;color:#78350f;padding:10px;border-radius:12px}
    .timer{font-variant-numeric:tabular-nums}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">Ø£</div>
        <div>
          <h1 class="title">Ø§Ù‚Ø±Ø£ Ø§Ù„ÙƒÙ„Ù…Ø© â€” Ø¨Ø·Ø§Ù‚Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ©</h1>
          <p class="subtitle">Ù†Ø´Ø§Ø· ØµÙÙ‘ÙŠ ØµÙˆØªÙŠ + ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØªÙ‚Ø·ÙŠØ¹/Ø§Ù„Ù…Ù‡Ø§Ø±Ø© + ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª Ø§Ù„Ù…ØªØ¹Ù„Ù…/Ø©.</p>
        </div>
      </div>
      <div class="row">
        <button class="btn btn-ghost" id="btnHome" aria-label="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="btn btn-green" id="btnTeacher" aria-label="Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©">Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©</button>
      </div>
    </header>

    <!-- HOME VIEW -->
    <section id="view-home" class="view active">
      <div class="card stack">
        <h2 class="center" style="margin:0 0 6px 0;">Ø§Ø¨Ø¯Ø£/ÙŠ Ù…Ù† Ù‡Ù†Ø§</h2>
        <p class="center muted" style="margin:0 0 10px 0;">Ø§Ø®ØªÙØ±/ÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø£ÙˆÙ„Ù‹Ø§ØŒ Ø«Ù… Ø­Ø¯Ù‘Ø¯/ÙŠ Â«Ø§Ù„Ù…Ø¬Ø§Ù„Â» ÙˆÂ«Ø§Ù„Ù…Ù‡Ø§Ø±Ø©Â» ÙˆØ§Ø¶ØºØ·/ÙŠ Â«Ø§Ø¨Ø¯Ø£Â».</p>

        <div class="home-grid">
          <div class="card stack">
            <div class="row" style="justify-content:center">
              <span class="tag">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</span>
              <span class="tag">Ø³Ù‡Ù„</span>
            </div>
            <p class="center muted">Ø­Ø±ÙƒØ§Øª Ù‚ØµÙŠØ±Ø© ÙˆØ³ÙƒÙˆÙ† Ø¨Ø³ÙŠØ·ØŒ ÙƒÙ„Ù…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©.</p>
            <button class="btn btn-primary" onclick="openLevel(1)">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</button>
          </div>

          <div class="card stack">
            <div class="row" style="justify-content:center">
              <span class="tag">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2</span>
              <span class="tag">Ù…ØªÙˆØ³Ø·</span>
            </div>
            <p class="center muted">Ù…Ø¯ÙˆØ¯ Ø·ÙˆÙŠÙ„Ø© ÙˆØ´Ø¯Ù‘Ø© ÙˆØ¨Ø¹Ø¶ ØªØ±ÙƒÙŠØ¨ Ù…ØªÙ‚Ø¯Ù‘Ù….</p>
            <button class="btn btn-primary" onclick="openLevel(2)">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2</button>
          </div>

          <div class="card stack">
            <h3 class="center" style="margin:0">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
            <div class="row" style="justify-content:center;flex-wrap:wrap">
              <span class="pill">ğŸ“š Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª: <strong id="countAll"></strong></span>
              <span class="pill">ğŸ Ø·Ø¹Ø§Ù…: <strong id="countFood"></strong></span>
              <span class="pill">ğŸ¾ Ø­ÙŠÙˆØ§Ù†Ø§Øª: <strong id="countAnimals"></strong></span>
              <span class="pill">ğŸ« Ù…Ø¯Ø±Ø³ØªÙŠ: <strong id="countSchool"></strong></span>
              <span class="pill">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Ø¹Ø§Ø¦Ù„ØªÙŠ: <strong id="countFamily"></strong></span>
            </div>
            <div class="center">
              <button class="btn" onclick="startCards({level:null, domain:'all', skill:'all'})">Ø§Ø¨Ø¯Ø£ ÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LEVEL SELECT VIEW -->
    <section id="view-level" class="view">
      <div class="card">
        <h2 class="center" id="levelTitle">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙÙŠØ©</h2>
        <div class="grid-2">
          <div class="card">
            <h3 class="center" style="margin-top:0">Ø§Ø®ØªØ±/ÙŠ Â«Ø§Ù„Ù…Ø¬Ø§Ù„Â»</h3>
            <div class="row" style="justify-content:center;flex-wrap:wrap">
              <label class="chip"><input type="radio" name="domain" value="all" checked> Ø§Ù„ÙƒÙ„</label>
              <label class="chip"><input type="radio" name="domain" value="Ø·Ø¹Ø§Ù…"> Ø·Ø¹Ø§Ù…</label>
              <label class="chip"><input type="radio" name="domain" value="Ø­ÙŠÙˆØ§Ù†Ø§Øª"> Ø­ÙŠÙˆØ§Ù†Ø§Øª</label>
              <label class="chip"><input type="radio" name="domain" value="Ù…Ø¯Ø±Ø³ØªÙŠ"> Ù…Ø¯Ø±Ø³ØªÙŠ</label>
              <label class="chip"><input type="radio" name="domain" value="Ø¹Ø§Ø¦Ù„ØªÙŠ"> Ø¹Ø§Ø¦Ù„ØªÙŠ</label>
            </div>
          </div>
          <div class="card">
            <h3 class="center" style="margin-top:0">Ø§Ø®ØªØ±/ÙŠ Â«Ø§Ù„Ù…Ù‡Ø§Ø±Ø©Â»</h3>
            <div class="row" style="justify-content:center;flex-wrap:wrap">
              <label class="chip"><input type="radio" name="skill" value="all" checked> Ø§Ù„ÙƒÙ„</label>
              <label class="chip"><input type="radio" name="skill" value="short_vowels"> Ø­Ø±ÙƒØ§Øª Ù‚ØµÙŠØ±Ø©</label>
              <label class="chip"><input type="radio" name="skill" value="sukun"> Ø³ÙƒÙˆÙ†</label>
              <label class="chip"><input type="radio" name="skill" value="long_vowels"> Ù…Ø¯ÙˆØ¯</label>
              <label class="chip"><input type="radio" name="skill" value="shadda"> Ø´Ø¯Ù‘Ø©</label>
            </div>
          </div>
        </div>
        <div class="center" style="margin-top:10px">
          <button class="btn btn-primary" id="btnStartFiltered">Ø§Ø¨Ø¯Ø£</button>
          <button class="btn" onclick="go('view-home')">Ø±Ø¬ÙˆØ¹</button>
        </div>
      </div>
    </section>

    <!-- CARDS VIEW -->
    <section id="view-cards" class="view">
      <div class="toolbar">
        <div class="row">
          <span class="tag" id="tagLevel"></span>
          <span class="tag" id="tagDomain"></span>
          <span class="tag" id="tagSkill"></span>
        </div>
        <div class="row">
          <button class="btn" id="btnShowSeg">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ‚Ø·ÙŠØ¹</button>
          <button class="btn hidden" id="btnHideSeg">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ‚Ø·ÙŠØ¹</button>
        </div>
      </div>

      <div class="card">
        <div class="status">
          <span id="statusIndex">Ù¡/Ù¢Ù¤</span>
        </div>
        <div class="progress" aria-hidden="true" style="margin:8px 0 14px 0"><span id="bar" style="width:0%"></span></div>

        <h2 class="word" id="wordText">Ø³ÙÙ…ÙÙƒÙØ©ÙŒ</h2>
        <div id="segWrap" class="seg hidden" aria-live="polite"></div>

        <div class="sentence">
          <button class="inline-btn" id="btnSpeakSentence" aria-label="Ø§Ù†Ø·Ù‚ Ø§Ù„Ø¬Ù…Ù„Ø©">ğŸ”Š</button>
          <span id="sentenceText">Ø³ÙÙ…ÙÙƒÙØ©ÙŒ ÙÙÙŠ Ø§Ù„Ø­ÙÙˆÙ’Ø¶Ù.</span>
        </div>

        <div class="row" style="justify-content:center;margin:8px 0 4px 0">
          <button class="btn" id="btnSpeakWord" aria-label="Ø§Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø©">ğŸ”Š Ø§Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø©</button>
          <button class="btn" id="btnCopyWord" aria-label="Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙ„Ù…Ø©">ğŸ“‹ Ù†Ø³Ø®</button>
        </div>

        <div class="sep"></div>

        <!-- AUDIO RECORDING -->
        <div class="kdraw audioBox">
          <div class="row" style="justify-content:space-between;align-items:center">
            <strong>ğŸ™ï¸ Ø³Ø¬Ù‘Ù„/ÙŠ Ù‚Ø±Ø§Ø¡ØªÙƒ</strong>
            <span class="pill" id="recOverall">Ø¬Ø§Ù‡Ø²</span>
          </div>

          <div class="grid-2" style="margin-top:10px">
            <div class="card stack" style="box-shadow:none;border:1px solid #dcfce7">
              <div class="row" style="justify-content:space-between;align-items:center">
                <strong>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø©</strong>
                <span class="muted timer" id="recWordTimer">00:00</span>
              </div>
              <div class="row" style="justify-content:center;flex-wrap:wrap">
                <button class="btn" id="btnRecWordStart">ğŸ™ï¸ Ø§Ø¨Ø¯Ø£</button>
                <button class="btn btn-primary hidden" id="btnRecWordStop">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
                <button class="btn" id="btnRecWordPlay" disabled>â–¶ï¸ ØªØ´ØºÙŠÙ„</button>
                <button class="btn" id="btnRecWordDelete" disabled>ğŸ—‘ï¸ Ø­Ø°Ù</button>
              </div>
              <audio id="audioWord" class="hidden" controls style="width:100%"></audio>
            </div>

            <div class="card stack" style="box-shadow:none;border:1px solid #dcfce7">
              <div class="row" style="justify-content:space-between;align-items:center">
                <strong>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù…Ù„Ø©</strong>
                <span class="muted timer" id="recSentTimer">00:00</span>
              </div>
              <div class="row" style="justify-content:center;flex-wrap:wrap">
                <button class="btn" id="btnRecSentStart">ğŸ™ï¸ Ø§Ø¨Ø¯Ø£</button>
                <button class="btn btn-primary hidden" id="btnRecSentStop">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
                <button class="btn" id="btnRecSentPlay" disabled>â–¶ï¸ ØªØ´ØºÙŠÙ„</button>
                <button class="btn" id="btnRecSentDelete" disabled>ğŸ—‘ï¸ Ø­Ø°Ù</button>
              </div>
              <audio id="audioSent" class="hidden" controls style="width:100%"></audio>
            </div>
          </div>

          <p class="hint" style="margin:8px 2px 0 0">
            Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ ÙˆÙ„Ø§ ÙŠØªÙ… Ø±ÙØ¹Ù‡ Ù„Ø£ÙŠ Ø¬Ù‡Ø©. Ù‚Ø¯ ÙŠØ·Ù„Ø¨ Ø§Ù„Ù…ØªØµÙØ­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. (HTTPS/localhost Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ØªØ³Ø¬ÙŠÙ„)
          </p>
        </div>

        <div class="sep"></div>

        <!-- COPYING AREA -->
        <div class="kdraw">
          <div class="row" style="justify-content:space-between;align-items:center">
            <strong>âœï¸ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù†Ø³Ø®</strong>
            <div class="row">
              <label class="chip"><input type="radio" name="mode" value="pen" checked> Ø±Ø³Ù… Ø¨Ø§Ù„Ù‚Ù„Ù…/Ø§Ù„ÙØ£Ø±Ø©</label>
              <label class="chip"><input type="radio" name="mode" value="text"> ÙƒØªØ§Ø¨Ø© Ø¨Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­</label>
              <button class="inline-btn" id="btnClearDraw">Ù…Ø³Ø­</button>
            </div>
          </div>
          <div id="penArea"><canvas id="pad" width="900" height="300"></canvas></div>
          <div id="textArea" class="hidden">
            <textarea id="typing" class="typing" dir="rtl" placeholder="Ø§ÙƒØªØ¨/ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© Ù‡Ù†Ø§â€¦"></textarea>
          </div>
          <p class="hint" style="margin:6px 2px 0 0">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¶Ø¹ Â«Ø§Ù„Ø±Ø³Ù…Â» Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙØ£Ø±Ø©/Ø§Ù„Ù‚Ù„Ù…ØŒ Ø£Ùˆ Â«Ø§Ù„ÙƒØªØ§Ø¨Ø©Â» Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ. (Ù„Ø§ ØªÙØ­ÙÙØ¸ Ø§Ù„Ø±Ø³Ù…Ø©.)</p>
        </div>

        <div class="controls">
          <button class="btn" id="btnPrev">Ø§Ù„Ø³Ø§Ø¨Ù‚ â†</button>
          <button class="btn btn-primary" id="btnNext">Ø§Ù„ØªØ§Ù„ÙŠ â†’</button>
        </div>
      </div>

      <footer>ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Â«Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©Â».</footer>
    </section>

    <!-- TEACHER VIEW -->
    <section id="view-teacher" class="view">
      <div class="card stack">
        <h2 style="margin:0">Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©</h2>
        <p class="muted" style="margin:0">Ù„ÙˆØ­Ø© Ù„Ù„Ù…Ø¹Ù„Ù…/Ø© Ù„Ù„ØªØ­ÙƒÙ‘Ù… ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ (Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©).</p>

        <div class="grid-2">
          <div class="card stack">
            <h3 style="margin:0">Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª ÙˆØ§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</h3>
            <table class="table">
              <thead><tr><th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th><th>Ø§Ù„ØªØ±ÙƒÙŠØ²</th><th>Ø£Ù…Ø«Ù„Ø©</th></tr></thead>
              <tbody>
                <tr><td>1</td><td>Ø­Ø±ÙƒØ§Øª Ù‚ØµÙŠØ±Ø© + Ø³ÙƒÙˆÙ†</td><td>Ù‚ÙÙ„ÙÙ…ÙŒØŒ Ø¯ÙÙÙ’ØªÙØ±ÙŒØŒ Ù…ÙÙƒÙ’ØªÙØ¨ÙŒâ€¦</td></tr>
                <tr><td>2</td><td>Ù…Ø¯ÙˆØ¯ + Ø´Ø¯Ù‘Ø©</td><td>ÙƒÙØªÙØ§Ø¨ÙŒØŒ ØªÙÙÙ‘ÙØ§Ø­ÙØ©ÙŒØŒ Ù‚ÙØ·Ù‘ÙØ©ÙŒâ€¦</td></tr>
              </tbody>
            </table>
            <div class="note">Ù†ØµÙŠØ­Ø©: Ø§Ø·Ù„Ø¨/ÙŠ Ù…Ù† Ø§Ù„Ø·Ø§Ù„Ø¨/Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙ„Ù…Ø© Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø£Ùˆ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙ‡/Ø§.</div>
          </div>

          <div class="card stack">
            <h3 style="margin:0">Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>

            <div class="row" style="justify-content:space-between;align-items:center;margin-top:6px">
              <label class="chip">
                <input type="checkbox" id="autoAnalyze" checked>
                ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØªÙ‚Ø·ÙŠØ¹/Ø§Ù„Ù…Ù‡Ø§Ø±Ø©/Ø§Ù„Ù…Ø³ØªÙˆÙ‰
              </label>
              <button class="inline-btn" id="btnAnalyzeNow">âš™ï¸ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¢Ù†</button>
            </div>
            <p class="hint" style="margin:0">Ø§ÙƒØªØ¨/ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© (Ù…Ø´ÙƒÙˆÙ„Ø©) ÙˆØ³ÙŠÙ‚ØªØ±Ø­ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø·ÙŠØ¹ ÙˆØ§Ù„Ù…Ù‡Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠÙ‹Ø§).</p>

            <div class="grid-2">
              <div class="field"><label>Ø§Ù„ÙƒÙ„Ù…Ø© (Ù…Ø´ÙƒÙˆÙ„Ø©)</label><input id="fWord" placeholder="Ù…Ø«Ø§Ù„: Ù‚ÙÙ„ÙÙ…ÙŒ"></div>
              <div class="field"><label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label>
                <select id="fLevel">
                  <option value="1">1 â€” Ø³Ù‡Ù„</option>
                  <option value="2">2 â€” Ù…ØªÙˆØ³Ø·</option>
                </select>
              </div>
              <div class="field"><label>Ø§Ù„Ù…Ø¬Ø§Ù„</label>
                <select id="fDomain">
                  <option>Ù…Ø¯Ø±Ø³ØªÙŠ</option>
                  <option>Ø·Ø¹Ø§Ù…</option>
                  <option>Ø­ÙŠÙˆØ§Ù†Ø§Øª</option>
                  <option>Ø¹Ø§Ø¦Ù„ØªÙŠ</option>
                </select>
              </div>
              <div class="field"><label>Ø§Ù„Ù…Ù‡Ø§Ø±Ø©</label>
                <select id="fSkill">
                  <option value="short_vowels">Ø­Ø±ÙƒØ§Øª Ù‚ØµÙŠØ±Ø©</option>
                  <option value="sukun">Ø³ÙƒÙˆÙ†</option>
                  <option value="long_vowels">Ù…Ø¯ÙˆØ¯</option>
                  <option value="shadda">Ø´Ø¯Ù‘Ø©</option>
                </select>
              </div>
              <div class="field" style="grid-column:1/-1"><label>Ø§Ù„ØªÙ‚Ø·ÙŠØ¹ Ø§Ù„ØµÙˆØªÙŠ (Ø§Ø³ØªØ®Ø¯Ù… Â«/Â» Ø¨ÙŠÙ† Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹)</label><input id="fSeg" placeholder="Ù‚Ù / Ù„Ù / Ù…ÙŒ"></div>
              <div class="field" style="grid-column:1/-1"><label>Ø¬Ù…Ù„Ø© Ù‚ØµÙŠØ±Ø©</label><input id="fSent" placeholder="Ù‡ÙØ°ÙØ§ Ù‚ÙÙ„ÙÙ…ÙŒ Ø£ÙØ²Ù’Ø±ÙÙ‚Ù."></div>
            </div>
            <div class="row" style="justify-content:flex-end">
              <button class="btn btn-green" id="btnAdd">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
          </div>
        </div>

        <div class="card stack">
          <h3 style="margin:0">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â€” ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯</h3>
          <div class="row" style="flex-wrap:wrap;gap:10px">
            <button class="btn" id="btnExport">ØªØµØ¯ÙŠØ± JSON (Versioned)</button>
            <label class="btn">
              Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
              <input id="fileImport" type="file" accept="application/json" style="display:none">
            </label>
            <button class="btn" id="btnReset">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</button>
          </div>
          <p class="hint">
            ØªÙØ­ÙÙØ¸ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ <strong>localStorage</strong> Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.
            ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙÙ‹Ø§ Ù‚Ø¯ÙŠÙ…Ù‹Ø§ (Ù…ØµÙÙˆÙØ©) Ø£Ùˆ Ù…Ù„ÙÙ‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ (ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ <strong>cards</strong> Ùˆ<strong>version</strong>).
          </p>
        </div>

        <div class="center">
          <button class="btn" onclick="go('view-home')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
      </div>
    </section>

    <footer>Â© Ø§Ù‚Ø±Ø£ Ø§Ù„ÙƒÙ„Ù…Ø© â€” Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ© â€” Ø¨Ø±Ù…Ø¬Ø© /Ø£: ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ</footer>
  </div>

<script>
'use strict';

/* âœ… Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Øµ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ â€œPut your HTML text hereâ€ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ­Ù‚Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© */
(function removeInjectedEnglishText(){
  const target = "Put your HTML text here";
  try{
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
    const nodes = [];
    while(walker.nextNode()){
      const n = walker.currentNode;
      if(n.nodeValue && n.nodeValue.trim() === target) nodes.push(n);
    }
    nodes.forEach(n=>{
      const p = n.parentElement;
      if(p && p.textContent.trim()===target) p.remove();
      else n.nodeValue = '';
    });
  }catch(e){}
})();

/* ---------- Ø£Ø±Ù‚Ø§Ù… Ù‡Ù†Ø¯ÙŠØ© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ---------- */
function toArabicDigits(n){
  const map = ['Ù ','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©'];
  return String(n).replace(/[0-9]/g, d => map[Number(d)]);
}

/* =========================
   ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¢Ù„ÙŠ (Seg + Skill + Level)
========================= */
const MARKS = {
  TANWIN_FATH:'\u064B', TANWIN_DAMM:'\u064C', TANWIN_KASR:'\u064D',
  FATHA:'\u064E', DAMMA:'\u064F', KASRA:'\u0650',
  SHADDA:'\u0651', SUKUN:'\u0652', DAGGER:'\u0670'
};
function isDiacritic(ch){ return /[\u064B-\u0652\u0670]/.test(ch); }
function stripTatweel(s){ return (s||'').replace(/\u0640/g,''); }
function baseChar(cluster){ for(const ch of cluster){ if(!isDiacritic(ch)) return ch; } return ''; }
function marksOf(cluster){ return (cluster||'').replace(/[^\u064B-\u0652\u0670]/g,''); }
function shortVowelType(cluster){
  const m = marksOf(cluster);
  if(m.includes(MARKS.FATHA) || m.includes(MARKS.TANWIN_FATH)) return 'a';
  if(m.includes(MARKS.DAMMA) || m.includes(MARKS.TANWIN_DAMM)) return 'u';
  if(m.includes(MARKS.KASRA) || m.includes(MARKS.TANWIN_KASR)) return 'i';
  return null;
}
function splitClusters(word){
  const s = stripTatweel(String(word||''));
  const clusters = [];
  let current = '';
  for(let i=0;i<s.length;i++){
    const ch = s[i];
    if(isDiacritic(ch)){
      if(current) current += ch;
      else clusters.push(ch);
      continue;
    }
    if(current) clusters.push(current);
    current = ch;
  }
  if(current) clusters.push(current);
  return clusters.filter(c=>c.trim().length>0);
}
function canMergeLong(prevCluster, nextCluster){
  const v = shortVowelType(prevCluster);
  if(!v) return false;
  const nextBase = baseChar(nextCluster);
  const nextMarks = marksOf(nextCluster);
  if(nextMarks.length>0) return false;
  if(v==='a' && (nextBase==='Ø§' || nextBase==='Ù‰' || nextBase==='Ø¢')) return true;
  if(v==='u' && nextBase==='Ùˆ') return true;
  if(v==='i' && nextBase==='ÙŠ') return true;
  return false;
}
function autoSegment(word){
  const clusters = splitClusters(word);
  const segs = [];
  for(let i=0;i<clusters.length;i++){
    let c = clusters[i];
    if(i+1<clusters.length && canMergeLong(c, clusters[i+1])){
      c = c + clusters[i+1];
      i++;
    }
    segs.push(c);
  }
  return segs.join(' / ');
}
function hasLongVowelPattern(word){
  if(String(word||'').includes('Ø¢')) return true;
  const clusters = splitClusters(word);
  for(let i=0;i<clusters.length-1;i++){
    if(canMergeLong(clusters[i], clusters[i+1])) return true;
  }
  return false;
}
function detectSkill(word){
  const w = String(word||'');
  if(w.includes(MARKS.SHADDA)) return 'shadda';
  if(hasLongVowelPattern(w)) return 'long_vowels';
  if(w.includes(MARKS.SUKUN)) return 'sukun';
  return 'short_vowels';
}
function recommendLevel(word, skill, seg){
  let lvl = (skill==='shadda' || skill==='long_vowels') ? 2 : 1;
  const parts = String(seg||'').split('/').map(x=>x.trim()).filter(Boolean);
  if(parts.length >= 5) lvl = Math.max(lvl, 2);
  return lvl;
}
function analyzeWord(word){
  const seg = autoSegment(word);
  const skill = detectSkill(word);
  const level = recommendLevel(word, skill, seg);
  return {seg, skill, level};
}

/* =========================
   Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª + Ø§Ù„ØªØ®Ø²ÙŠÙ†
========================= */
const DATA_VERSION = 1;
const STORAGE_KEY = 'iqra_cards_v3';
const LEGACY_KEY = 'iqra_cards_v2';

const DEFAULT_DATA = [
  { word:'Ù‚ÙÙ„ÙÙ…ÙŒ', seg:'Ù‚Ù / Ù„Ù / Ù…ÙŒ', sentence:'Ù‡ÙØ°ÙØ§ Ù‚ÙÙ„ÙÙ…ÙŒ Ø£ÙØ²Ù’Ø±ÙÙ‚Ù.', domain:'Ù…Ø¯Ø±Ø³ØªÙŠ', level:1, skill:'short_vowels' },
  { word:'Ø¯ÙÙÙ’ØªÙØ±ÙŒ', seg:'Ø¯Ù / ÙÙ’ / ØªÙ / Ø±ÙŒ', sentence:'Ù‡ÙØ°ÙØ§ Ø¯ÙÙÙ’ØªÙØ±ÙŒ Ø¬ÙØ¯ÙÙŠØ¯ÙŒ.', domain:'Ù…Ø¯Ø±Ø³ØªÙŠ', level:1, skill:'sukun' },
  { word:'Ù…ÙÙƒÙ’ØªÙØ¨ÙŒ', seg:'Ù…Ù / ÙƒÙ’ / ØªÙ / Ø¨ÙŒ', sentence:'ÙÙÙŠ Ø§Ù„ØµÙ‘ÙÙÙ‘Ù Ù…ÙÙƒÙ’ØªÙØ¨ÙŒ ÙƒÙØ¨ÙÙŠØ±ÙŒ.', domain:'Ù…Ø¯Ø±Ø³ØªÙŠ', level:1, skill:'sukun' },
  { word:'Ù…ÙØ³Ù’Ø·ÙØ±ÙØ©ÙŒ', seg:'Ù…Ù / Ø³Ù’ / Ø·Ù / Ø±Ù / Ø©ÙŒ', sentence:'Ø¹ÙÙ†Ù’Ø¯ÙÙŠ Ù…ÙØ³Ù’Ø·ÙØ±ÙØ©ÙŒ Ø·ÙÙˆÙÙŠÙ„ÙØ©ÙŒ.', domain:'Ù…Ø¯Ø±Ø³ØªÙŠ', level:1, skill:'sukun' },
  { word:'Ø®ÙØ¨Ù’Ø²ÙŒ', seg:'Ø®Ù / Ø¨Ù’ / Ø²ÙŒ', sentence:'Ø£ÙØ­ÙØ¨Ù‘Ù Ø®ÙØ¨Ù’Ø²Ù‹Ø§ Ø³ÙØ§Ø®ÙÙ†Ù‹Ø§.', domain:'Ø·Ø¹Ø§Ù…', level:1, skill:'sukun' },
  { word:'Ø¹ÙØ³ÙÙ„ÙŒ', seg:'Ø¹Ù / Ø³Ù / Ù„ÙŒ', sentence:'Ø§Ù„Ø¹ÙØ³ÙÙ„Ù Ù„ÙØ°ÙÙŠØ°ÙŒ.', domain:'Ø·Ø¹Ø§Ù…', level:1, skill:'short_vowels' },
  { word:'Ù…ÙÙˆÙ’Ø²ÙŒ', seg:'Ù…ÙÙˆÙ’ / Ø²ÙŒ', sentence:'Ø§Ù„Ù…ÙÙˆÙ’Ø²Ù Ø·ÙØ¹ÙØ§Ù…ÙŒ Ù…ÙÙÙÙŠØ¯ÙŒ.', domain:'Ø·Ø¹Ø§Ù…', level:1, skill:'sukun' },
  { word:'Ø£ÙØ±Ù’Ø²ÙŒ', seg:'Ø£Ù / Ø±Ù’ / Ø²ÙŒ', sentence:'Ù†ÙØ£Ù’ÙƒÙÙ„Ù Ø£ÙØ±Ù’Ø²Ù‹Ø§ Ø¨ÙØ§Ù„Ø®ÙØ¶ÙØ§Ø±Ù.', domain:'Ø·Ø¹Ø§Ù…', level:1, skill:'sukun' },
  { word:'Ø£ÙØ±Ù’Ù†ÙØ¨ÙŒ', seg:'Ø£Ù / Ø±Ù’ / Ù†Ù / Ø¨ÙŒ', sentence:'Ø§Ù„Ø£ÙØ±Ù’Ù†ÙØ¨Ù Ø³ÙØ±ÙÙŠØ¹ÙŒ.', domain:'Ø­ÙŠÙˆØ§Ù†Ø§Øª', level:1, skill:'sukun' },
  { word:'Ù†ÙØ­Ù’Ù„ÙØ©ÙŒ', seg:'Ù†Ù / Ø­Ù’ / Ù„Ù / Ø©ÙŒ', sentence:'Ø§Ù„Ù†Ù‘ÙØ­Ù’Ù„ÙØ©Ù ØªÙØµÙ’Ù†ÙØ¹Ù Ø§Ù„Ø¹ÙØ³ÙÙ„Ù.', domain:'Ø­ÙŠÙˆØ§Ù†Ø§Øª', level:1, skill:'sukun' },
  { word:'Ø·ÙÙŠÙ’Ø±ÙŒ', seg:'Ø·Ù / ÙŠÙ’ / Ø±ÙŒ', sentence:'Ø§Ù„Ø·Ù‘ÙÙŠÙ’Ø±Ù ÙŠÙØ·ÙÙŠØ±Ù ÙÙÙŠ Ø§Ù„Ø³Ù‘ÙÙ…ÙØ§Ø¡Ù.', domain:'Ø­ÙŠÙˆØ§Ù†Ø§Øª', level:1, skill:'sukun' },
  { word:'Ø³ÙÙ…ÙÙƒÙØ©ÙŒ', seg:'Ø³Ù / Ù…Ù / ÙƒÙ / Ø©ÙŒ', sentence:'Ø³ÙÙ…ÙÙƒÙØ©ÙŒ ÙÙÙŠ Ø§Ù„Ø­ÙÙˆÙ’Ø¶Ù.', domain:'Ø­ÙŠÙˆØ§Ù†Ø§Øª', level:1, skill:'short_vowels' },

  { word:'ÙƒÙØªÙØ§Ø¨ÙŒ', seg:'ÙƒÙ / ØªØ§ / Ø¨ÙŒ', sentence:'Ø£ÙÙ‚Ù’Ø±ÙØ£Ù ÙƒÙØªÙØ§Ø¨Ù‹Ø§ Ù…ÙÙÙÙŠØ¯Ù‹Ø§.', domain:'Ù…Ø¯Ø±Ø³ØªÙŠ', level:2, skill:'long_vowels' },
  { word:'Ø¯ÙØ±ÙÙˆØ³ÙŒ', seg:'Ø¯Ù / Ø±ÙÙˆ / ØµÙŒ', sentence:'Ù„ÙØ¯ÙÙŠÙ’Ù†ÙØ§ Ø¯ÙØ±ÙÙˆØ³ÙŒ Ù…ÙÙ‡ÙÙ…Ù‘ÙØ©ÙŒ.', domain:'Ù…Ø¯Ø±Ø³ØªÙŠ', level:2, skill:'long_vowels' },
  { word:'Ù…ÙØ¹ÙÙ„Ù‘ÙÙ…ÙØ©ÙŒ', seg:'Ù…Ù / Ø¹ÙÙ„Ù‘Ù / Ù…Ù / Ø©ÙŒ', sentence:'Ù…ÙØ¹ÙÙ„Ù‘ÙÙ…ÙØªÙÙ†ÙØ§ Ø±ÙØ§Ø¦ÙØ¹ÙØ©ÙŒ.', domain:'Ù…Ø¯Ø±Ø³ØªÙŠ', level:2, skill:'shadda' },
  { word:'ÙƒÙØ±Ù’Ø³ÙÙŠÙ‘ÙŒ', seg:'ÙƒÙ / Ø±Ù’ / Ø³ÙÙŠÙ‘ÙŒ', sentence:'Ù‡ÙØ°ÙØ§ ÙƒÙØ±Ù’Ø³ÙÙŠÙ‘ÙŒ Ù…ÙØ±ÙÙŠØ­ÙŒ.', domain:'Ù…Ø¯Ø±Ø³ØªÙŠ', level:2, skill:'long_vowels' },

  { word:'Ù‚ÙØ·Ù‘ÙØ©ÙŒ', seg:'Ù‚Ù / Ø·Ù‘Ù / Ø©ÙŒ', sentence:'Ù‚ÙØ·Ù‘ÙØªÙÙŠ ØµÙØºÙÙŠØ±ÙØ©ÙŒ.', domain:'Ø­ÙŠÙˆØ§Ù†Ø§Øª', level:2, skill:'shadda' },
  { word:'Ø¬ÙÙ…ÙØ§Ù„ÙŒ', seg:'Ø¬Ù / Ù…Ø§ / Ù„ÙŒ', sentence:'Ø§Ù„Ø¬ÙÙ…ÙØ§Ù„Ù Ø­ÙÙŠÙÙˆÙØ§Ù†ÙØ§ØªÙŒ ØµÙØ¨ÙÙˆØ±ÙØ©ÙŒ.', domain:'Ø­ÙŠÙˆØ§Ù†Ø§Øª', level:2, skill:'long_vowels' },
  { word:'Ø°ÙØ¦ÙØ§Ø¨ÙŒ', seg:'Ø°Ù / Ø¢ / Ø¨ÙŒ', sentence:'ØªÙØ¹ÙÙŠØ´Ù Ø§Ù„Ø°Ù‘ÙØ¦ÙØ§Ø¨Ù ÙÙÙŠ Ø§Ù„ØºÙØ§Ø¨ÙØ©Ù.', domain:'Ø­ÙŠÙˆØ§Ù†Ø§Øª', level:2, skill:'long_vowels' },

  { word:'ØªÙÙÙ‘ÙØ§Ø­ÙØ©ÙŒ', seg:'ØªÙ / ÙÙ‘ÙØ§ / Ø­Ù / Ø©ÙŒ', sentence:'Ø¢ÙƒÙÙ„Ù ØªÙÙÙ‘ÙØ§Ø­ÙØ©Ù‹ ÙƒÙÙ„Ù‘Ù ÙŠÙÙˆÙ’Ù…Ù.', domain:'Ø·Ø¹Ø§Ù…', level:2, skill:'shadda' },
  { word:'Ø­ÙÙ„ÙÙŠØ¨ÙŒ', seg:'Ø­Ù / Ù„ÙÙŠ / Ø¨ÙŒ', sentence:'Ø£ÙØ´Ù’Ø±ÙØ¨Ù Ø­ÙÙ„ÙÙŠØ¨Ù‹Ø§ Ø¯ÙØ§ÙÙØ¦Ù‹Ø§.', domain:'Ø·Ø¹Ø§Ù…', level:2, skill:'long_vowels' },
  { word:'Ø²ÙÙŠÙ’ØªÙÙˆÙ†ÙŒ', seg:'Ø²ÙÙŠÙ’ / ØªÙÙˆ / Ù†ÙŒ', sentence:'Ù†ÙØ£Ù’ÙƒÙÙ„Ù Ø§Ù„Ø²Ù‘ÙÙŠÙ’ØªÙÙˆÙ†Ù Ù…ÙØ¹Ù Ø§Ù„Ø®ÙØ¨Ù’Ø²Ù.', domain:'Ø·Ø¹Ø§Ù…', level:2, skill:'long_vowels' },
  { word:'Ø¹ÙØµÙÙŠØ±ÙŒ', seg:'Ø¹Ù / ØµÙÙŠ / Ø±ÙŒ', sentence:'Ø£ÙÙÙØ¶Ù‘ÙÙ„Ù Ø¹ÙØµÙÙŠØ±Ù Ø§Ù„Ø¨ÙØ±Ù’ØªÙÙ‚ÙØ§Ù„Ù.', domain:'Ø·Ø¹Ø§Ù…', level:2, skill:'long_vowels' },

  { word:'Ø£ÙÙ…Ù‘ÙŒ', seg:'Ø£Ù / Ù…Ù‘ÙŒ', sentence:'Ø£ÙÙ…Ù‘ÙÙŠ ÙƒÙØ±ÙÙŠÙ…ÙØ©ÙŒ.', domain:'Ø¹Ø§Ø¦Ù„ØªÙŠ', level:2, skill:'shadda' },
  { word:'Ø¬ÙØ¯Ù‘ÙØ©ÙŒ', seg:'Ø¬Ù / Ø¯Ù‘Ù / Ø©ÙŒ', sentence:'Ø£ÙØ­ÙØ¨Ù‘Ù Ø¬ÙØ¯Ù‘ÙØªÙÙŠ.', domain:'Ø¹Ø§Ø¦Ù„ØªÙŠ', level:2, skill:'shadda' },
  { word:'Ø£ÙØ³Ù’Ø±ÙØ©ÙŒ', seg:'Ø£Ù / Ø³Ù’ / Ø±Ù / Ø©ÙŒ', sentence:'Ù‡ÙØ°ÙÙ‡Ù Ø£ÙØ³Ù’Ø±ÙØªÙÙŠ.', domain:'Ø¹Ø§Ø¦Ù„ØªÙŠ', level:2, skill:'sukun' }
];

function saveData(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY) || localStorage.getItem(LEGACY_KEY);
  if(!raw){ saveData(DEFAULT_DATA); return [...DEFAULT_DATA]; }
  try{
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)) return parsed;
    if(parsed && typeof parsed === 'object' && Array.isArray(parsed.cards)) return parsed.cards;
  }catch{}
  return [...DEFAULT_DATA];
}

function normalizeCard(card){
  const word = String(card?.word||'').trim();
  const sentence = String(card?.sentence||'').trim();
  const domain = String(card?.domain||'Ù…Ø¯Ø±Ø³ØªÙŠ').trim() || 'Ù…Ø¯Ø±Ø³ØªÙŠ';
  let seg = String(card?.seg||'').trim();
  let skill = String(card?.skill||'').trim();
  let level = Number(card?.level||0);
  if(!word || !sentence) return null;

  const auto = analyzeWord(word);
  if(!seg) seg = auto.seg;
  if(!['short_vowels','sukun','long_vowels','shadda'].includes(skill)) skill = auto.skill;
  if(!(level===1 || level===2)) level = auto.level;

  return {word, seg, sentence, domain, level, skill};
}
function normalizeAll(cards){
  const out = [];
  let changed = false;
  for(const c of cards){
    const n = normalizeCard(c);
    if(n){ out.push(n); if(JSON.stringify(n)!==JSON.stringify(c)) changed = true; }
    else changed = true;
  }
  return {out, changed};
}

let DATA = loadData();
{
  const {out, changed} = normalizeAll(DATA);
  DATA = out;
  if(changed) saveData(DATA);
}

/* ---------- Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---------- */
function updateCounts(){
  const all = DATA.length;
  const food = DATA.filter(x=>x.domain==='Ø·Ø¹Ø§Ù…').length;
  const animals = DATA.filter(x=>x.domain==='Ø­ÙŠÙˆØ§Ù†Ø§Øª').length;
  const school = DATA.filter(x=>x.domain==='Ù…Ø¯Ø±Ø³ØªÙŠ').length;
  const family = DATA.filter(x=>x.domain==='Ø¹Ø§Ø¦Ù„ØªÙŠ').length;
  document.getElementById('countAll').textContent = toArabicDigits(all);
  document.getElementById('countFood').textContent = toArabicDigits(food);
  document.getElementById('countAnimals').textContent = toArabicDigits(animals);
  document.getElementById('countSchool').textContent = toArabicDigits(school);
  document.getElementById('countFamily').textContent = toArabicDigits(family);
}

/* ---------- ØªÙ†Ù‚Ù‘Ù„ ---------- */
function go(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0, behavior:'smooth'});
}
document.getElementById('btnHome').addEventListener('click', ()=>go('view-home'));
document.getElementById('btnTeacher').addEventListener('click', ()=>go('view-teacher'));

/* ---------- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„Ø¨Ø¯Ø¡ ---------- */
let currentSet = [];
let currentIndex = 0;
let currentFilters = { level:null, domain:'all', skill:'all' };

function openLevel(level){
  currentFilters.level = level;
  document.getElementById('levelTitle').textContent = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ' + level + ' â€” Ø§Ø®ØªØ±/ÙŠ Ø§Ù„ØªØµÙÙŠØ©';
  go('view-level');
}
document.getElementById('btnStartFiltered').addEventListener('click', ()=>{
  const domain = document.querySelector('input[name="domain"]:checked').value;
  const skill = document.querySelector('input[name="skill"]:checked').value;
  startCards({level: currentFilters.level, domain, skill});
});
function startCards({level=null, domain='all', skill='all'}){
  currentFilters = {level, domain, skill};
  currentSet = DATA.filter(item=>{
    const okLevel = (level===null) ? true : item.level===level;
    const okDomain = (domain==='all') ? true : item.domain===domain;
    const okSkill = (skill==='all') ? true : item.skill===skill;
    return okLevel && okDomain && okSkill;
  });
  confirmStopRecordingIfAny();
  if(currentSet.length===0){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆÙÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.'); return; }
  currentIndex = 0;
  renderTags();
  go('view-cards');
  renderCard();
}
function renderTags(){
  const tL = document.getElementById('tagLevel');
  const tD = document.getElementById('tagDomain');
  const tS = document.getElementById('tagSkill');
  tL.textContent = currentFilters.level? ('Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ' + currentFilters.level): 'ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª';
  tD.textContent = currentFilters.domain==='all'? 'ÙƒÙ„ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª' : currentFilters.domain;
  const skillMap = {all:'ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª', short_vowels:'Ø­Ø±ÙƒØ§Øª Ù‚ØµÙŠØ±Ø©', sukun:'Ø³ÙƒÙˆÙ†', long_vowels:'Ù…Ø¯ÙˆØ¯', shadda:'Ø´Ø¯Ù‘Ø©'};
  tS.textContent = skillMap[currentFilters.skill];
}

/* ---------- Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ---------- */
const elWord = document.getElementById('wordText');
const elSeg = document.getElementById('segWrap');
const elSent = document.getElementById('sentenceText');
const elStatus = document.getElementById('statusIndex');
const bar = document.getElementById('bar');
const btnShowSeg = document.getElementById('btnShowSeg');
const btnHideSeg = document.getElementById('btnHideSeg');

function hideSeg(){ elSeg.classList.add('hidden'); btnHideSeg.classList.add('hidden'); btnShowSeg.classList.remove('hidden'); }
function showSeg(){ elSeg.classList.remove('hidden'); btnHideSeg.classList.remove('hidden'); btnShowSeg.classList.add('hidden'); }
btnShowSeg.addEventListener('click', showSeg);
btnHideSeg.addEventListener('click', hideSeg);

function safeSegHTML(segStr){
  const seg = String(segStr||'');
  return seg.split('/').map(x=>`<span>${x.trim()}</span>`).join('');
}

let CURRENT_CARD_KEY = null;
function cardKey(item){ return (item.word||'') + '||' + (item.sentence||'') + '||' + (item.domain||''); }

function renderCard(){
  const item = currentSet[currentIndex];
  if(!item.seg || !item.skill || !item.level){
    const auto = analyzeWord(item.word);
    item.seg = item.seg || auto.seg;
    item.skill = item.skill || auto.skill;
    item.level = item.level || auto.level;
  }
  elWord.textContent = item.word;
  elSeg.innerHTML = safeSegHTML(item.seg);
  elSent.textContent = item.sentence;

  const idx = toArabicDigits(currentIndex+1) + ' / ' + toArabicDigits(currentSet.length);
  elStatus.textContent = idx;
  bar.style.width = ((currentIndex+1)/currentSet.length*100).toFixed(2)+'%';

  CURRENT_CARD_KEY = cardKey(item);
  hideSeg();
  clearTyping();
  clearPad();
  refreshRecordingUI();
}

/* ØªÙ†Ù‚Ù„ */
document.getElementById('btnNext').addEventListener('click', ()=>{
  confirmStopRecordingIfAny();
  if(currentIndex<currentSet.length-1){ currentIndex++; renderCard(); }
});
document.getElementById('btnPrev').addEventListener('click', ()=>{
  confirmStopRecordingIfAny();
  if(currentIndex>0){ currentIndex--; renderCard(); }
});

/* Ù†Ø³Ø® */
document.getElementById('btnCopyWord').addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(elWord.textContent);
    alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙ„Ù…Ø© âœ”');
  }catch{ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®.'); }
});

/* ---------- Ø§Ù„Ù†Ø·Ù‚ ---------- */
let AR_VOICES = [];
function pickArabicVoice(){
  const v = speechSynthesis.getVoices().filter(v=>/^ar(-|$)/i.test(v.lang));
  AR_VOICES = v;
}
if('speechSynthesis' in window){
  speechSynthesis.onvoiceschanged = pickArabicVoice;
  pickArabicVoice();
}
function speak(text){
  if(!('speechSynthesis' in window)){ alert('Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ø·Ù‚ ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.'); return; }
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ar-SA';
  u.rate = 0.85; u.pitch = 1.05;
  if(AR_VOICES.length){ u.voice = AR_VOICES[0]; }
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
document.getElementById('btnSpeakWord').addEventListener('click', ()=>speak(elWord.textContent));
document.getElementById('btnSpeakSentence').addEventListener('click', ()=>speak(elSent.textContent));

/* ---------- Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù†Ø³Ø® ---------- */
const penArea = document.getElementById('penArea');
const textArea = document.getElementById('textArea');
const typing = document.getElementById('typing');
function setMode(mode){
  if(mode==='text'){ penArea.classList.add('hidden'); textArea.classList.remove('hidden'); typing.focus(); }
  else{ textArea.classList.add('hidden'); penArea.classList.remove('hidden'); }
}
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener('change', (e)=> setMode(e.target.value));
});
function clearTyping(){ typing.value=''; }

const pad = document.getElementById('pad');
const ctx = pad.getContext('2d');
function fitCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio||1);
  const cssWidth = pad.clientWidth;
  const cssHeight = pad.clientHeight;
  pad.width = Math.floor(cssWidth * dpr);
  pad.height = Math.floor(cssHeight * dpr);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr, dpr);
  ctx.lineCap = 'round'; ctx.lineJoin='round';
  ctx.lineWidth = 4; ctx.strokeStyle = '#111827';
  ctx.clearRect(0,0,cssWidth,cssHeight);
}
function clearPad(){ fitCanvas(); }
fitCanvas(); window.addEventListener('resize', fitCanvas);

let drawing = false, lastX=0, lastY=0;
function ppos(e){
  const r = pad.getBoundingClientRect();
  return {x: e.clientX - r.left, y: e.clientY - r.top};
}
pad.addEventListener('pointerdown', (e)=>{
  drawing = true;
  const p = ppos(e); lastX=p.x; lastY=p.y;
  pad.setPointerCapture(e.pointerId);
  e.preventDefault();
});
pad.addEventListener('pointermove', (e)=>{
  if(!drawing) return;
  const p = ppos(e);
  ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke();
  lastX=p.x; lastY=p.y;
  e.preventDefault();
});
pad.addEventListener('pointerup', (e)=>{ drawing=false; try{pad.releasePointerCapture(e.pointerId);}catch{} e.preventDefault(); });
pad.addEventListener('pointercancel', ()=>{ drawing=false; });
document.getElementById('btnClearDraw').addEventListener('click', clearPad);

/* ---------- Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ (Ù†ÙØ³ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù) ---------- */
const recOverall = document.getElementById('recOverall');
const btnRecWordStart = document.getElementById('btnRecWordStart');
const btnRecWordStop  = document.getElementById('btnRecWordStop');
const btnRecWordPlay  = document.getElementById('btnRecWordPlay');
const btnRecWordDelete= document.getElementById('btnRecWordDelete');
const audioWord       = document.getElementById('audioWord');
const recWordTimer    = document.getElementById('recWordTimer');

const btnRecSentStart = document.getElementById('btnRecSentStart');
const btnRecSentStop  = document.getElementById('btnRecSentStop');
const btnRecSentPlay  = document.getElementById('btnRecSentPlay');
const btnRecSentDelete= document.getElementById('btnRecSentDelete');
const audioSent       = document.getElementById('audioSent');
const recSentTimer    = document.getElementById('recSentTimer');

const recordings = new Map();
function getRecEntry(key){ if(!recordings.has(key)) recordings.set(key, {word:null, sentence:null}); return recordings.get(key); }
function revokeIfAny(rec){ if(rec && rec.url){ try{ URL.revokeObjectURL(rec.url); }catch{} } }
function formatTime(ms){
  const total = Math.floor(ms/1000);
  const mm = String(Math.floor(total/60)).padStart(2,'0');
  const ss = String(total%60).padStart(2,'0');
  return `${mm}:${ss}`;
}
let recState = {active:false,type:null,key:null,stream:null,recorder:null,chunks:[],startedAt:0,timerId:null};
function canRecord(){ return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia && window.MediaRecorder); }
function setOverallStatus(text){ recOverall.textContent = text; }
function setButtonsWhileRecording(type, isOn){
  const other = type==='word' ? 'sentence' : 'word';
  if(type==='word'){ btnRecWordStart.classList.toggle('hidden', isOn); btnRecWordStop.classList.toggle('hidden', !isOn); }
  else{ btnRecSentStart.classList.toggle('hidden', isOn); btnRecSentStop.classList.toggle('hidden', !isOn); }
  if(isOn){
    if(other==='word') btnRecWordStart.disabled = true;
    if(other==='sentence') btnRecSentStart.disabled = true;
    btnRecWordPlay.disabled = btnRecSentPlay.disabled = true;
    btnRecWordDelete.disabled = btnRecSentDelete.disabled = true;
  }else{
    btnRecWordStart.disabled = false;
    btnRecSentStart.disabled = false;
  }
}
async function startRecording(type){
  if(recState.active) return;
  if(!canRecord()){ alert('Ù…ÙŠØ²Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.'); return; }
  if(!CURRENT_CARD_KEY){ alert('Ø§Ø¨Ø¯Ø£/ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø£ÙˆÙ„Ù‹Ø§.'); return; }

  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    let options = {};
    const prefer = 'audio/webm;codecs=opus';
    if(MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(prefer)) options.mimeType = prefer;
    const recorder = new MediaRecorder(stream, options);

    recState = {active:true,type,key:CURRENT_CARD_KEY,stream,recorder,chunks:[],startedAt:Date.now(),timerId:null};
    setButtonsWhileRecording(type, true);
    setOverallStatus('ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...');

    const timerEl = (type==='word') ? recWordTimer : recSentTimer;
    timerEl.textContent = '00:00';
    recState.timerId = setInterval(()=>{ timerEl.textContent = formatTime(Date.now()-recState.startedAt); }, 200);

    recorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) recState.chunks.push(e.data); };
    recorder.onstop = ()=>{
      try{ clearInterval(recState.timerId); }catch{}
      const blob = new Blob(recState.chunks, {type: recorder.mimeType || 'audio/webm'});
      const url = URL.createObjectURL(blob);
      const entry = getRecEntry(recState.key);

      const slot = (type==='word') ? entry.word : entry.sentence;
      revokeIfAny(slot);
      if(type==='word') entry.word = {blob, url};
      else entry.sentence = {blob, url};

      try{ recState.stream.getTracks().forEach(t=>t.stop()); }catch{}
      recState.active = false;
      setButtonsWhileRecording(type, false);
      setOverallStatus('Ø¬Ø§Ù‡Ø²');
      refreshRecordingUI();
    };
    recorder.start();
  }catch(err){
    console.error(err);
    alert('ØªØ¹Ø°Ù‘Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ØªØ£ÙƒØ¯/ÙŠ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTPS.');
    recState.active = false;
    setOverallStatus('Ø¬Ø§Ù‡Ø²');
    setButtonsWhileRecording(type, false);
  }
}
function stopRecording(){ if(recState.active && recState.recorder) try{ recState.recorder.stop(); }catch{} }
function confirmStopRecordingIfAny(){ if(recState.active) stopRecording(); }
function refreshRecordingUI(){
  if(!CURRENT_CARD_KEY) return;
  const entry = getRecEntry(CURRENT_CARD_KEY);

  if(entry.word && entry.word.url){
    btnRecWordPlay.disabled = false; btnRecWordDelete.disabled = false;
    audioWord.src = entry.word.url; audioWord.classList.remove('hidden');
  }else{
    btnRecWordPlay.disabled = true; btnRecWordDelete.disabled = true;
    audioWord.removeAttribute('src'); audioWord.classList.add('hidden'); recWordTimer.textContent='00:00';
  }
  if(entry.sentence && entry.sentence.url){
    btnRecSentPlay.disabled = false; btnRecSentDelete.disabled = false;
    audioSent.src = entry.sentence.url; audioSent.classList.remove('hidden');
  }else{
    btnRecSentPlay.disabled = true; btnRecSentDelete.disabled = true;
    audioSent.removeAttribute('src'); audioSent.classList.add('hidden'); recSentTimer.textContent='00:00';
  }
  if(!canRecord()) setOverallStatus('Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù‡Ù†Ø§');
  else if(!recState.active) setOverallStatus('Ø¬Ø§Ù‡Ø²');
}
btnRecWordStart.addEventListener('click', ()=>startRecording('word'));
btnRecSentStart.addEventListener('click', ()=>startRecording('sentence'));
btnRecWordStop.addEventListener('click', stopRecording);
btnRecSentStop.addEventListener('click', stopRecording);
btnRecWordPlay.addEventListener('click', ()=>{ if(!audioWord.classList.contains('hidden')) audioWord.play(); });
btnRecSentPlay.addEventListener('click', ()=>{ if(!audioSent.classList.contains('hidden')) audioSent.play(); });
btnRecWordDelete.addEventListener('click', ()=>{
  if(!CURRENT_CARD_KEY) return;
  const entry = getRecEntry(CURRENT_CARD_KEY);
  if(entry.word){ revokeIfAny(entry.word); entry.word=null; }
  refreshRecordingUI();
});
btnRecSentDelete.addEventListener('click', ()=>{
  if(!CURRENT_CARD_KEY) return;
  const entry = getRecEntry(CURRENT_CARD_KEY);
  if(entry.sentence){ revokeIfAny(entry.sentence); entry.sentence=null; }
  refreshRecordingUI();
});

/* ---------- Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø© ---------- */
const fWord = document.getElementById('fWord');
const fSeg  = document.getElementById('fSeg');
const fSent = document.getElementById('fSent');
const fLevel= document.getElementById('fLevel');
const fDomain=document.getElementById('fDomain');
const fSkill=document.getElementById('fSkill');
const autoAnalyze = document.getElementById('autoAnalyze');
const btnAnalyzeNow = document.getElementById('btnAnalyzeNow');

function runAutoFill(){
  const w = fWord.value.trim(); if(!w) return;
  const a = analyzeWord(w);
  fSeg.value = a.seg;
  fSkill.value = a.skill;
  fLevel.value = String(a.level);
}
fWord.addEventListener('input', ()=>{ if(autoAnalyze.checked) runAutoFill(); });
btnAnalyzeNow.addEventListener('click', ()=>{ runAutoFill(); alert('ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ âœ” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.'); });

document.getElementById('btnAdd').addEventListener('click', ()=>{
  const w = fWord.value.trim();
  let seg = fSeg.value.trim();
  const sent = fSent.value.trim();
  let level = Number(fLevel.value);
  const domain = fDomain.value;
  let skill = fSkill.value;

  if(!w || !sent){ alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø©: Ø§Ù„ÙƒÙ„Ù…Ø© + Ø§Ù„Ø¬Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'); return; }

  if(autoAnalyze.checked){
    const a = analyzeWord(w);
    if(!seg) seg = a.seg;
    if(!skill) skill = a.skill;
    if(!(level===1 || level===2)) level = a.level;
  }
  if(!seg){ alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ‚Ø·ÙŠØ¹ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.'); return; }

  DATA.push({word:w, seg, sentence:sent, domain, level, skill});
  saveData(DATA);
  updateCounts();
  alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ”');
  fWord.value=''; fSeg.value=''; fSent.value='';
});

/* ---------- ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ ---------- */
document.getElementById('btnExport').addEventListener('click', ()=>{
  const payload = {version: DATA_VERSION, exportedAt: new Date().toISOString(), cards: DATA};
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'iqra-cards.v' + DATA_VERSION + '.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
});
function parseImportedJSON(resultText){
  const obj = JSON.parse(resultText);
  let cards = obj;
  if(obj && typeof obj==='object' && Array.isArray(obj.cards)) cards = obj.cards;
  if(!Array.isArray(cards)) throw new Error('bad-format');
  const {out} = normalizeAll(cards);
  if(out.length===0) throw new Error('empty');
  return out;
}
document.getElementById('fileImport').addEventListener('change', (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      DATA = parseImportedJSON(r.result);
      saveData(DATA);
      updateCounts();
      alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ”');
    }catch(err){
      console.error(err);
      alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­. ØªØ£ÙƒØ¯/ÙŠ Ø£Ù†Ù‡ JSON ØµØ­ÙŠØ­ ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø§Øª.');
    }
  };
  r.readAsText(file, 'utf-8');
});
document.getElementById('btnReset').addEventListener('click', ()=>{
  if(confirm('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŸ Ø³ÙŠÙØ³ØªØ¨Ø¯Ù„ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„.')){
    DATA = [...DEFAULT_DATA];
    saveData(DATA);
    updateCounts();
    alert('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ”');
  }
});

/* ---------- ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ---------- */
updateCounts();
</script>
</body>
</html>
