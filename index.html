<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุงูุฑุฃ ุงููููุฉ โ ุจุทุงูุงุช ุชูุงุนููุฉ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f5f7ff;
      --ink:#101828;
      --accent:#0ea5e9;
      --accent-2:#22c55e;
      --surface:#ffffff;
      --muted:#667085;
      --ring:#bae6fd;
      --shadow: 0 10px 25px rgba(2,8,23,.08);
      --rounded: 1.25rem;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Cairo', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans Arabic', Tahoma, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 600px at 80% -20%, #dbeafe 0%, transparent 70%),
                  radial-gradient(900px 500px at -10% 110%, #dcfce7 0%, transparent 70%),
                  var(--bg);
    }
    a{color:var(--accent)}
    .container{max-width:980px;margin:0 auto;padding:24px}
    header{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;margin-bottom:20px
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, #38bdf8, #22c55e);
      box-shadow: var(--shadow); display:grid;place-items:center;color:#fff;font-weight:900
    }
    .card{
      background:var(--surface);
      border-radius:var(--rounded);
      padding:20px;
      box-shadow:var(--shadow);
      border:1px solid #eff6ff;
    }
    .home-grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:720px){ .home-grid{grid-template-columns:repeat(3, 1fr)} }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:.6rem;
      padding:12px 16px;border-radius:14px;border:1px solid #e5e7eb;
      background:#fff;color:var(--ink);text-decoration:none;font-weight:700;
      box-shadow:var(--shadow);cursor:pointer;transition:all .15s ease
    }
    .btn:hover{transform:translateY(-1px);}
    .btn-primary{background:linear-gradient(180deg,#38bdf8,#0ea5e9);color:#fff;border-color:transparent}
    .btn-green{background:linear-gradient(180deg,#34d399,#22c55e);color:#073b1a;border-color:transparent}
    .btn-ghost{background:transparent;border-color:#dbeafe}
    .tag{display:inline-block;font-size:.85rem;background:#eff6ff;color:#075985;border:1px solid #e0f2fe;border-radius:999px;padding:2px 10px;margin-inline:4px}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .hidden{display:none !important}
    .center{text-align:center}
    .title{font-size:clamp(1.6rem,3vw,2.2rem);margin:0}
    .subtitle{margin:0;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:.5rem;
      padding:8px 12px;border-radius:999px;background:#fff;border:1px solid #e5e7eb;box-shadow:var(--shadow)
    }
    .view{display:none}
    .view.active{display:block}
    .toolbar{display:flex;justify-content:space-between;gap:10px;align-items:center;margin:8px 0 14px}
    .status{font-weight:700}
    .progress{
      height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden
    }
    .progress > span{
      display:block;height:100%;background:linear-gradient(90deg,#38bdf8,#22c55e)
    }
    .word{
      font-size:clamp(2.4rem,5vw,3.8rem);margin:0 0 8px 0;letter-spacing:.5px
    }
    .seg{font-size:1.2rem;color:#0f766e;background:#ecfeff;border:1px dashed #a5f3fc;border-radius:14px;padding:10px 12px;display:inline-flex;gap:.65rem;flex-wrap:wrap}
    .sentence{font-size:1.2rem;margin:12px auto;color:#334155;background:#f8fafc;border:1px solid #e2e8f0;border-radius:14px;padding:12px;display:inline-flex;align-items:center;gap:10px}
    .controls{display:flex;justify-content:center;gap:10px;margin:14px 0 0}
    .controls .btn{min-width:120px}
    .inline-btn{border:none;background:#eef2ff;color:#3730a3;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
    .muted{color:#64748b}
    .sep{height:1px;background:#eef2ff;margin:12px 0}
    .kdraw{border:2px dashed #c7d2fe;border-radius:16px;background:#fafaff;padding:10px}
    canvas{background:#fff;border-radius:12px;display:block;width:100%;height:220px;border:1px solid #e5e7eb; touch-action:none;}
    .typing{width:100%;height:220px;border:1px solid #e5e7eb;border-radius:12px;padding:16px;
            font-size:2rem;line-height:2.6rem;text-align:center;background:#fff}
    footer{margin-top:24px;color:#64748b;font-size:.95rem;text-align:center}
    .chip{display:inline-flex;align-items:center;border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:6px 10px;gap:.5rem}
    .chip input{margin:0}
    .grid-2{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:820px){.grid-2{grid-template-columns:1fr 1fr}}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #eef2ff;padding:8px 6px;text-align:center}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field select,.field textarea{
      padding:10px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-family:inherit
    }
    .hint{font-size:.92rem;color:#6b7280}
    .note{background:#fffbeb;border:1px solid #fde68a;color:#78350f;padding:10px;border-radius:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">ุฃ</div>
        <div>
          <h1 class="title">ุงูุฑุฃ ุงููููุฉ โ ุจุทุงูุงุช ุชูุงุนููุฉ</h1>
          <p class="subtitle">ูุดุงุท ุตููู ุตูุชู ูุน ุชุฏุฑูุฌ ููุงุฑู (ุญุฑูุงุช/ูุฏูุฏ/ุดุฏูุฉ) ูุชูุณูู ุฅูู ูุฌุงูุงุช.</p>
        </div>
      </div>
      <div class="row">
        <button class="btn btn-ghost" id="btnHome" aria-label="ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ">ุงูุฑุฆูุณูุฉ</button>
        <button class="btn btn-green" id="btnTeacher" aria-label="ููุชุงุญ ุงููุนููุฉ">ููุชุงุญ ุงููุนููุฉ</button>
      </div>
    </header>

    <!-- HOME VIEW -->
    <section id="view-home" class="view active">
      <div class="card stack">
        <h2 class="center" style="margin:0 0 6px 0;">ุงุจุฏุฆู ูู ููุง</h2>
        <p class="center muted" style="margin:0 0 10px 0;">ุงุฎุชุงุฑู ุงููุณุชูู ุฃูููุงุ ุซู ุญุฏูุฏู ยซุงููุฌุงูยป ูยซุงูููุงุฑุฉยป ูุงุถุบุทู ุงุจุฏุฃ.</p>
        <div class="home-grid">
          <div class="card stack">
            <div class="row" style="justify-content:center">
              <span class="tag">ุงููุณุชูู 1</span>
              <span class="tag">ุณูู</span>
            </div>
            <p class="center muted">ุญุฑูุงุช ูุตูุฑุฉ ูุณููู ุจุณูุทุ ูููุงุช ุฃุณุงุณูุฉ.</p>
            <button class="btn btn-primary" onclick="openLevel(1)">ุงุจุฏุฃ ุงููุณุชูู 1</button>
          </div>
          <div class="card stack">
            <div class="row" style="justify-content:center">
              <span class="tag">ุงููุณุชูู 2</span>
              <span class="tag">ูุชูุณุท</span>
            </div>
            <p class="center muted">ูุฏูุฏ ุทูููุฉ ูุดุฏูุฉ ูุจุนุถ ุชุฑููุจ ูุชูุฏูู.</p>
            <button class="btn btn-primary" onclick="openLevel(2)">ุงุจุฏุฃ ุงููุณุชูู 2</button>
          </div>
          <div class="card stack">
            <h3 class="center" style="margin:0">ุฑูุงุจุท ุณุฑูุนุฉ</h3>
            <div class="row" style="justify-content:center;flex-wrap:wrap">
              <span class="pill">๐ ุฌููุน ุงูุจุทุงูุงุช: <strong id="countAll"></strong></span>
              <span class="pill">๐ ุทุนุงู: <strong id="countFood"></strong></span>
              <span class="pill">๐พ ุญููุงูุงุช: <strong id="countAnimals"></strong></span>
              <span class="pill">๐ซ ูุฏุฑุณุชู: <strong id="countSchool"></strong></span>
              <span class="pill">๐จโ๐ฉโ๐งโ๐ฆ ุนุงุฆูุชู: <strong id="countFamily"></strong></span>
            </div>
            <div class="center">
              <button class="btn" onclick="startCards({level:null, domain:'all', skill:'all'})">ุงุจุฏุฃ ูู ุงูุจุทุงูุงุช</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LEVEL SELECT VIEW -->
    <section id="view-level" class="view">
      <div class="card">
        <h2 class="center" id="levelTitle">ุงุฎุชูุงุฑ ุงูุชุตููุฉ</h2>
        <div class="grid-2">
          <div class="card">
            <h3 class="center" style="margin-top:0">ุงุฎุชุฑ ยซุงููุฌุงูยป</h3>
            <div class="row" style="justify-content:center;flex-wrap:wrap">
              <label class="chip"><input type="radio" name="domain" value="all" checked> ุงููู</label>
              <label class="chip"><input type="radio" name="domain" value="ุทุนุงู"> ุทุนุงู</label>
              <label class="chip"><input type="radio" name="domain" value="ุญููุงูุงุช"> ุญููุงูุงุช</label>
              <label class="chip"><input type="radio" name="domain" value="ูุฏุฑุณุชู"> ูุฏุฑุณุชู</label>
              <label class="chip"><input type="radio" name="domain" value="ุนุงุฆูุชู"> ุนุงุฆูุชู</label>
            </div>
          </div>
          <div class="card">
            <h3 class="center" style="margin-top:0">ุงุฎุชุฑ ยซุงูููุงุฑุฉยป</h3>
            <div class="row" style="justify-content:center;flex-wrap:wrap">
              <label class="chip"><input type="radio" name="skill" value="all" checked> ุงููู</label>
              <label class="chip"><input type="radio" name="skill" value="short_vowels"> ุญุฑูุงุช ูุตูุฑุฉ</label>
              <label class="chip"><input type="radio" name="skill" value="sukun"> ุณููู</label>
              <label class="chip"><input type="radio" name="skill" value="long_vowels"> ูุฏูุฏ</label>
              <label class="chip"><input type="radio" name="skill" value="shadda"> ุดุฏูุฉ</label>
            </div>
          </div>
        </div>
        <div class="center" style="margin-top:10px">
          <button class="btn btn-primary" id="btnStartFiltered">ุงุจุฏุฃ</button>
          <button class="btn" onclick="go('view-home')">ุฑุฌูุน</button>
        </div>
      </div>
    </section>

    <!-- CARDS VIEW -->
    <section id="view-cards" class="view">
      <div class="toolbar">
        <div class="row">
          <span class="tag" id="tagLevel"></span>
          <span class="tag" id="tagDomain"></span>
          <span class="tag" id="tagSkill"></span>
        </div>
        <div class="row">
          <button class="btn" id="btnShowSeg">ุฅุธูุงุฑ ุงูุชูุทูุน</button>
          <button class="btn" id="btnHideSeg" class="hidden">ุฅุฎูุงุก ุงูุชูุทูุน</button>
        </div>
      </div>

      <div class="card">
        <div class="status">
          <span id="statusIndex">ูก/ูขูค</span>
        </div>
        <div class="progress" aria-hidden="true" style="margin:8px 0 14px 0"><span id="bar" style="width:0%"></span></div>

        <h2 class="word" id="wordText">ุณูููููุฉู</h2>

        <div id="segWrap" class="seg hidden" aria-live="polite"></div>

        <div class="sentence">
          <button class="inline-btn" id="btnSpeakSentence" aria-label="ุงูุทู ุงูุฌููุฉ">๐</button>
          <span id="sentenceText">ุณูููููุฉู ููุฐููุฐูุฉู ููู ุงูุจูุญูุฑู.</span>
        </div>

        <div class="row" style="justify-content:center;margin:8px 0 4px 0">
          <button class="btn" id="btnSpeakWord" aria-label="ุงูุทู ุงููููุฉ">๐ ุงูุทู ุงููููุฉ</button>
          <button class="btn" id="btnCopyWord" aria-label="ุงูุณุฎ ุงููููุฉ">๐ ูุณุฎ</button>
        </div>

        <div class="sep"></div>

        <div class="kdraw">
          <div class="row" style="justify-content:space-between;align-items:center">
            <strong>โ๏ธ ูุณุงุญุฉ ุงููุณุฎ</strong>
            <div class="row">
              <label class="chip"><input type="radio" name="mode" value="pen" checked> ุฑุณู ุจุงูููู/ุงููุฃุฑุฉ</label>
              <label class="chip"><input type="radio" name="mode" value="text"> ูุชุงุจุฉ ุจููุญุฉ ุงูููุงุชูุญ</label>
              <button class="inline-btn" id="btnClearDraw">ูุณุญ</button>
            </div>
          </div>
          <div id="penArea"><canvas id="pad" width="900" height="300"></canvas></div>
          <div id="textArea" class="hidden">
            <textarea id="typing" class="typing" dir="rtl" placeholder="ุงูุชุจู ุงููููุฉ ููุงโฆ"></textarea>
          </div>
          <p class="hint" style="margin:6px 2px 0 0">ุงุฎุชุงุฑู ูุถุน ยซุงูุฑุณูยป ูุงุณุชุฎุฏุงู ุงููุฃุฑุฉ/ุงููููุ ุฃู ยซุงููุชุงุจุฉยป ูุฅุฏุฎุงู ูุต. (ูุง ุชูุญููุธ ุงูุฑุณูุฉ.)</p>
        </div>

        <div class="controls">
          <button class="btn" id="btnPrev">ุงูุณุงุจู โ</button>
          <button class="btn btn-primary" id="btnNext">ุงูุชุงูู โ</button>
        </div>
      </div>
      <footer>ูููู ุชุนุฏูู ุงูุจุทุงูุงุช ูุฅุถุงูุฉ ุจุทุงูุงุช ุฌุฏูุฏุฉ ูู ยซููุชุงุญ ุงููุนููุฉยป.</footer>
    </section>

    <!-- TEACHER VIEW -->
    <section id="view-teacher" class="view">
      <div class="card stack">
        <h2 style="margin:0">ููุชุงุญ ุงููุนููุฉ</h2>
        <p class="muted" style="margin:0">ุชุญููู ูู ุงูุจูุงูุงุช ูุงูุฅุนุฏุงุฏุงุช. ูู ุดูุก ูุนูู ูุญูููุง ุฏุงุฎู ุงููุชุตูุญ (ูุง ุชูุฌุฏ ูุงุนุฏุฉ ุจูุงูุงุช ุฎุงุฑุฌูุฉ).</p>

        <div class="grid-2">
          <div class="card stack">
            <h3 style="margin:0">ูุตูููุฉ ุงููุณุชููุงุช ูุงูููุงุฑุงุช</h3>
            <table class="table">
              <thead><tr><th>ุงููุณุชูู</th><th>ุงูุชุฑููุฒ</th><th>ุฃูุซูุฉ</th></tr></thead>
              <tbody>
                <tr><td>1</td><td>ุญุฑูุงุช ูุตูุฑุฉ + ุณููู</td><td>ููููููุ ุฏูููุชูุฑูุ ููููุชูุจูโฆ</td></tr>
                <tr><td>2</td><td>ูุฏูุฏ + ุดุฏูุฉ</td><td>ููุชูุงุจูุ ุชููููุงุญูุฉูุ ููุทููุฉูโฆ</td></tr>
              </tbody>
            </table>
            <div class="note">ูุตูุญุฉ: ุงุทูุจู ูู ุงูุทุงูุจุฉ ูุฑุงุกุฉ ุงููููุฉ ูุจู ุชุดุบูู ุงูุตูุช.</div>
          </div>

          <div class="card stack">
            <h3 style="margin:0">ุฅุถุงูุฉ ุจุทุงูุฉ ุฌุฏูุฏุฉ</h3>
            <div class="grid-2">
              <div class="field"><label>ุงููููุฉ (ูุดูููุฉ)</label><input id="fWord" placeholder="ูุซุงู: ูููููู"></div>
              <div class="field"><label>ุงููุณุชูู</label>
                <select id="fLevel">
                  <option value="1">1 โ ุณูู</option>
                  <option value="2">2 โ ูุชูุณุท</option>
                </select>
              </div>
              <div class="field"><label>ุงููุฌุงู</label>
                <select id="fDomain">
                  <option>ูุฏุฑุณุชู</option>
                  <option>ุทุนุงู</option>
                  <option>ุญููุงูุงุช</option>
                  <option>ุนุงุฆูุชู</option>
                </select>
              </div>
              <div class="field"><label>ุงูููุงุฑุฉ</label>
                <select id="fSkill">
                  <option value="short_vowels">ุญุฑูุงุช ูุตูุฑุฉ</option>
                  <option value="sukun">ุณููู</option>
                  <option value="long_vowels">ูุฏูุฏ</option>
                  <option value="shadda">ุดุฏูุฉ</option>
                </select>
              </div>
              <div class="field" style="grid-column:1/-1"><label>ุงูุชูุทูุน ุงูุตูุชู (ุงุณุชุฎุฏู ยซ/ยป ุจูู ุงูููุงุทุน)</label><input id="fSeg" placeholder="ูู / ูู / ูู"></div>
              <div class="field" style="grid-column:1/-1"><label>ุฌููุฉ ูุตูุฑุฉ</label><input id="fSent" placeholder="ููุฐูุง ูููููู ุฃูุฒูุฑููู."></div>
            </div>
            <div class="row" style="justify-content:flex-end">
              <button class="btn btn-green" id="btnAdd">ุฅุถุงูุฉ</button>
            </div>
          </div>
        </div>

        <div class="card stack">
          <h3 style="margin:0">ุงูุจูุงูุงุช โ ุชุตุฏูุฑ/ุงุณุชูุฑุงุฏ</h3>
          <div class="row" style="flex-wrap:wrap;gap:10px">
            <button class="btn" id="btnExport">ุชุตุฏูุฑ JSON</button>
            <label class="btn">
              ุงุณุชูุฑุงุฏ JSON
              <input id="fileImport" type="file" accept="application/json" style="display:none">
            </label>
            <button class="btn" id="btnReset">ุงุณุชุนุงุฏุฉ ูุฌููุนุฉ ุงูุจุฏุงูุฉ</button>
          </div>
          <p class="hint">ุชูุญููุธ ุฃู ุชุนุฏููุงุช ูู <strong>localStorage</strong> ุนูู ุฌูุงุฒู.</p>
        </div>

        <div class="center">
          <button class="btn" onclick="go('view-home')">ุฑุฌูุน ููุฑุฆูุณูุฉ</button>
        </div>
      </div>
    </section>

    <footer>ยฉ ุงูุฑุฃ ุงููููุฉ โ ูุณุฎุฉ ุชุฌุฑูุจูุฉ ุชุนููููุฉ โ ุจุฑูุฌุฉ /ุฃ: ูุงุทูุฉ ูุฒุงุฒู</footer>
  </div>

<script>
'use strict';

/* ---------- ุฃุฑูุงู ููุฏูุฉ ูููุงุฌูุฉ ---------- */
function toArabicDigits(n){
  const map = ['ู','ูก','ูข','ูฃ','ูค','ูฅ','ูฆ','ูง','ูจ','ูฉ'];
  return String(n).replace(/[0-9]/g, d => map[Number(d)]);
}

/* ---------- ุงูุจูุงูุงุช ุงูุงูุชุฑุงุถูุฉ (24 ุจุทุงูุฉ) ---------- */
const DEFAULT_DATA = [
  // ุงููุณุชูู 1 โ ูุฏุฑุณุชู
  { word:'ูููููู', seg:'ูู / ูู / ูู', sentence:'ููุฐูุง ูููููู ุฃูุฒูุฑููู.', domain:'ูุฏุฑุณุชู', level:1, skill:'short_vowels' },
  { word:'ุฏูููุชูุฑู', seg:'ุฏู / ูู / ุชู / ุฑู', sentence:'ููุฐูุง ุฏูููุชูุฑู ุฌูุฏููุฏู.', domain:'ูุฏุฑุณุชู', level:1, skill:'sukun' },
  { word:'ููููุชูุจู', seg:'ูู / ูู / ุชู / ุจู', sentence:'ููู ุงูุตููููู ููููุชูุจู ููุจููุฑู.', domain:'ูุฏุฑุณุชู', level:1, skill:'sukun' },
  { word:'ููุณูุทูุฑูุฉู', seg:'ูู / ุณู / ุทู / ุฑู / ุฉู', sentence:'ุนูููุฏูู ููุณูุทูุฑูุฉู ุทููููููุฉู.', domain:'ูุฏุฑุณุชู', level:1, skill:'sukun' },

  // ุงููุณุชูู 1 โ ุทุนุงู
  { word:'ุฎูุจูุฒู', seg:'ุฎู / ุจู / ุฒู', sentence:'ุฃูุญูุจูู ุฎูุจูุฒูุง ุณูุงุฎูููุง.', domain:'ุทุนุงู', level:1, skill:'sukun' },
  { word:'ุนูุณููู', seg:'ุนู / ุณู / ูู', sentence:'ุงูุนูุณููู ููุฐููุฐู.', domain:'ุทุนุงู', level:1, skill:'short_vowels' },
  { word:'ููููุฒู', seg:'ูููู / ุฒู', sentence:'ุงูููููุฒู ุทูุนูุงูู ูููููุฏู.', domain:'ุทุนุงู', level:1, skill:'sukun' },
  { word:'ุฃูุฑูุฒู', seg:'ุฃู / ุฑู / ุฒู', sentence:'ููุฃููููู ุฃูุฑูุฒูุง ุจูุงูุฎูุถูุงุฑู.', domain:'ุทุนุงู', level:1, skill:'sukun' },

  // ุงููุณุชูู 1 โ ุญููุงูุงุช
  { word:'ุฃูุฑูููุจู', seg:'ุฃู / ุฑู / ูู / ุจู', sentence:'ุงูุฃูุฑูููุจู ุณูุฑููุนู.', domain:'ุญููุงูุงุช', level:1, skill:'sukun' },
  { word:'ููุญูููุฉู', seg:'ูู / ุญู / ูู / ุฉู', sentence:'ุงููููุญูููุฉู ุชูุตูููุนู ุงูุนูุณููู.', domain:'ุญููุงูุงุช', level:1, skill:'sukun' },
  { word:'ุทูููุฑู', seg:'ุทู / ูู / ุฑู', sentence:'ุงูุทููููุฑู ููุทููุฑู ููู ุงูุณููููุงุกู.', domain:'ุญููุงูุงุช', level:1, skill:'sukun' },
  { word:'ุณูููููุฉู', seg:'ุณู / ูู / ูู / ุฉู', sentence:'ุณูููููุฉู ููู ุงูุญูููุถู.', domain:'ุญููุงูุงุช', level:1, skill:'short_vowels' },

  // ุงููุณุชูู 2 โ ูุฏุฑุณุชู
  { word:'ููุชูุงุจู', seg:'ูู / ุชุง / ุจู', sentence:'ุฃูููุฑูุฃู ููุชูุงุจูุง ูููููุฏูุง.', domain:'ูุฏุฑุณุชู', level:2, skill:'long_vowels' },
  { word:'ุฏูุฑููุณู', seg:'ุฏู / ุฑูู / ุตู', sentence:'ููุฏูููููุง ุฏูุฑููุณู ูููููููุฉู.', domain:'ูุฏุฑุณุชู', level:2, skill:'long_vowels' },
  { word:'ููุนููููููุฉู', seg:'ูู / ุนูููู / ูู / ุฉู', sentence:'ููุนููููููุชูููุง ุฑูุงุฆูุนูุฉู.', domain:'ูุฏุฑุณุชู', level:2, skill:'shadda' },
  { word:'ููุฑูุณูููู', seg:'ูู / ุฑู / ุณูููู', sentence:'ููุฐูุง ููุฑูุณูููู ููุฑููุญู.', domain:'ูุฏุฑุณุชู', level:2, skill:'long_vowels' },

  // ุงููุณุชูู 2 โ ุญููุงูุงุช
  { word:'ููุทููุฉู', seg:'ูู / ุทูู / ุฉู', sentence:'ููุทููุชูู ุตูุบููุฑูุฉู.', domain:'ุญููุงูุงุช', level:2, skill:'shadda' },
  { word:'ุฌูููุงูู', seg:'ุฌู / ูุง / ูู', sentence:'ุงูุฌูููุงูู ุญูููููุงููุงุชู ุตูุจููุฑูุฉู.', domain:'ุญููุงูุงุช', level:2, skill:'long_vowels' },
  { word:'ุฐูุฆูุงุจู', seg:'ุฐู / ุข / ุจู', sentence:'ุชูุนููุดู ุงูุฐููุฆูุงุจู ููู ุงูุบูุงุจูุฉู.', domain:'ุญููุงูุงุช', level:2, skill:'long_vowels' },

  // ุงููุณุชูู 2 โ ุทุนุงู
  { word:'ุชููููุงุญูุฉู', seg:'ุชู / ูููุง / ุญู / ุฉู', sentence:'ุขูููู ุชููููุงุญูุฉู ููููู ูููููู.', domain:'ุทุนุงู', level:2, skill:'shadda' },
  { word:'ุญููููุจู', seg:'ุญู / ููู / ุจู', sentence:'ุฃูุดูุฑูุจู ุญููููุจูุง ุฏูุงููุฆูุง.', domain:'ุทุนุงู', level:2, skill:'long_vowels' },
  { word:'ุฒูููุชูููู', seg:'ุฒููู / ุชูู / ูู', sentence:'ููุฃููููู ุงูุฒููููุชูููู ููุนู ุงูุฎูุจูุฒู.', domain:'ุทุนุงู', level:2, skill:'long_vowels' },
  { word:'ุนูุตููุฑู', seg:'ุนู / ุตูู / ุฑู', sentence:'ุฃูููุถูููู ุนูุตููุฑู ุงูุจูุฑูุชูููุงูู.', domain:'ุทุนุงู', level:2, skill:'long_vowels' },

  // ุงููุณุชูู 2 โ ุนุงุฆูุชู
  { word:'ุฃูููู', seg:'ุฃู / ููู', sentence:'ุฃููููู ููุฑููููุฉู.', domain:'ุนุงุฆูุชู', level:2, skill:'shadda' },
  { word:'ุฌูุฏููุฉู', seg:'ุฌู / ุฏูู / ุฉู', sentence:'ุฃูุญูุจูู ุฌูุฏููุชูู.', domain:'ุนุงุฆูุชู', level:2, skill:'shadda' },
  { word:'ุฃูุณูุฑูุฉู', seg:'ุฃู / ุณู / ุฑู / ุฉู', sentence:'ููุฐููู ุฃูุณูุฑูุชูู.', domain:'ุนุงุฆูุชู', level:2, skill:'sukun' }
];

const STORAGE_KEY = 'iqra_cards_v2';

/* ---------- ุชุฎุฒูู/ุชุญููู ---------- */
function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ localStorage.setItem(STORAGE_KEY, JSON.stringify(DEFAULT_DATA)); return [...DEFAULT_DATA]; }
  try{ return JSON.parse(raw); }catch{ return [...DEFAULT_DATA]; }
}
function saveData(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

let DATA = loadData();

/* ---------- ุนุฏุงุฏุงุช ุนูู ุงูุฑุฆูุณูุฉ ---------- */
function updateCounts(){
  const all = DATA.length;
  const food = DATA.filter(x=>x.domain==='ุทุนุงู').length;
  const animals = DATA.filter(x=>x.domain==='ุญููุงูุงุช').length;
  const school = DATA.filter(x=>x.domain==='ูุฏุฑุณุชู').length;
  const family = DATA.filter(x=>x.domain==='ุนุงุฆูุชู').length;
  document.getElementById('countAll').textContent = toArabicDigits(all);
  document.getElementById('countFood').textContent = toArabicDigits(food);
  document.getElementById('countAnimals').textContent = toArabicDigits(animals);
  document.getElementById('countSchool').textContent = toArabicDigits(school);
  document.getElementById('countFamily').textContent = toArabicDigits(family);
}

/* ---------- ุชูููู ุจูู ุงููุดุงูุฏ ---------- */
function go(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0, behavior:'smooth'});
}
document.getElementById('btnHome').addEventListener('click', ()=>go('view-home'));
document.getElementById('btnTeacher').addEventListener('click', ()=>go('view-teacher'));

/* ---------- ุงุฎุชูุงุฑ ุงููุณุชูู ูุงูุจุฏุก ---------- */
let currentSet = [];
let currentIndex = 0;
let currentFilters = { level:null, domain:'all', skill:'all' };

function openLevel(level){
  currentFilters.level = level;
  document.getElementById('levelTitle').textContent = 'ุงููุณุชูู ' + level + ' โ ุงุฎุชุฑ ุงูุชุตููุฉ';
  go('view-level');
}

document.getElementById('btnStartFiltered').addEventListener('click', ()=>{
  const domain = document.querySelector('input[name="domain"]:checked').value;
  const skill = document.querySelector('input[name="skill"]:checked').value;
  startCards({level: currentFilters.level, domain, skill});
});

function startCards({level=null, domain='all', skill='all'}){
  currentFilters = {level, domain, skill};
  currentSet = DATA.filter(item=>{
    const okLevel = (level===null) ? true : item.level===level;
    const okDomain = (domain==='all') ? true : item.domain===domain;
    const okSkill = (skill==='all') ? true : item.skill===skill;
    return okLevel && okDomain && okSkill;
  });
  if(currentSet.length===0){ alert('ูุง ุชูุฌุฏ ุจุทุงูุงุช ููู ุงูุชุตููุฉ ุงููุฎุชุงุฑุฉ.'); return; }
  currentIndex = 0;
  renderTags();
  go('view-cards');
  renderCard();
}

function renderTags(){
  const tL = document.getElementById('tagLevel');
  const tD = document.getElementById('tagDomain');
  const tS = document.getElementById('tagSkill');
  tL.textContent = currentFilters.level? ('ุงููุณุชูู ' + currentFilters.level): 'ูู ุงููุณุชููุงุช';
  tD.textContent = currentFilters.domain==='all'? 'ูู ุงููุฌุงูุงุช' : currentFilters.domain;
  const skillMap = {all:'ูู ุงูููุงุฑุงุช', short_vowels:'ุญุฑูุงุช ูุตูุฑุฉ', sukun:'ุณููู', long_vowels:'ูุฏูุฏ', shadda:'ุดุฏูุฉ'};
  tS.textContent = skillMap[currentFilters.skill];
}

/* ---------- ุจุทุงูุฉ ---------- */
const elWord = document.getElementById('wordText');
const elSeg = document.getElementById('segWrap');
const elSent = document.getElementById('sentenceText');
const elStatus = document.getElementById('statusIndex');
const bar = document.getElementById('bar');
const btnShowSeg = document.getElementById('btnShowSeg');
const btnHideSeg = document.getElementById('btnHideSeg');

function renderCard(){
  const item = currentSet[currentIndex];
  elWord.textContent = item.word;
  elSeg.innerHTML = item.seg.split('/').map(x=>`<span>${x.trim()}</span>`).join('');
  elSent.textContent = item.sentence;
  const idx = toArabicDigits(currentIndex+1) + ' / ' + toArabicDigits(currentSet.length);
  elStatus.textContent = idx;
  bar.style.width = ((currentIndex+1)/currentSet.length*100).toFixed(2)+'%';
  hideSeg();
  clearTyping();
  clearPad();
}

function hideSeg(){ elSeg.classList.add('hidden'); btnHideSeg.classList.add('hidden'); btnShowSeg.classList.remove('hidden'); }
function showSeg(){ elSeg.classList.remove('hidden'); btnHideSeg.classList.remove('hidden'); btnShowSeg.classList.add('hidden'); }
btnShowSeg.addEventListener('click', showSeg);
btnHideSeg.addEventListener('click', hideSeg);

/* ---------- ุชูููู ---------- */
document.getElementById('btnNext').addEventListener('click', ()=>{ if(currentIndex<currentSet.length-1){ currentIndex++; renderCard(); } });
document.getElementById('btnPrev').addEventListener('click', ()=>{ if(currentIndex>0){ currentIndex--; renderCard(); } });

/* ุฏุนู ุงูุณุญุจ ุนูู ุงูุฌูุงู */
let touchX = null;
document.getElementById('view-cards').addEventListener('touchstart', e=>{ touchX = e.changedTouches[0].clientX; }, {passive:true});
document.getElementById('view-cards').addEventListener('touchend', e=>{
  if(touchX===null) return;
  const dx = e.changedTouches[0].clientX - touchX;
  if(Math.abs(dx) > 60){
    if(dx < 0){ // ุณุญุจ ูููุณุงุฑ โ ุงูุชุงูู
      if(currentIndex<currentSet.length-1){ currentIndex++; renderCard(); }
    }else{
      if(currentIndex>0){ currentIndex--; renderCard(); }
    }
  }
  touchX = null;
}, {passive:true});

/* ---------- ูุณุฎ ุงููููุฉ ---------- */
document.getElementById('btnCopyWord').addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(elWord.textContent);
    alert('ุชู ูุณุฎ ุงููููุฉ โ');
  }catch{ alert('ุชุนุฐูุฑ ุงููุณุฎ.'); }
});

/* ---------- ูุทู ---------- */
let AR_VOICES = [];
function pickArabicVoice(){
  const v = speechSynthesis.getVoices().filter(v=>/^ar(-|$)/i.test(v.lang));
  AR_VOICES = v;
}
if('speechSynthesis' in window){
  speechSynthesis.onvoiceschanged = pickArabicVoice;
  pickArabicVoice();
}
function speak(text){
  if(!('speechSynthesis' in window)){ alert('ููุฒุฉ ุงููุทู ุบูุฑ ูุชุงุญุฉ ูู ูุฐุง ุงููุชุตูุญ.'); return; }
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ar-SA';
  u.rate = 0.85; u.pitch = 1.05;
  if(AR_VOICES.length){ u.voice = AR_VOICES[0]; }
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
document.getElementById('btnSpeakWord').addEventListener('click', ()=>speak(elWord.textContent));
document.getElementById('btnSpeakSentence').addEventListener('click', ()=>speak(elSent.textContent));

/* ---------- ูุถุน ุงููุชุงุจุฉ/ุงูุฑุณู ---------- */
const penArea = document.getElementById('penArea');
const textArea = document.getElementById('textArea');
const typing = document.getElementById('typing');
function setMode(mode){
  if(mode==='text'){ penArea.classList.add('hidden'); textArea.classList.remove('hidden'); typing.focus(); }
  else{ textArea.classList.add('hidden'); penArea.classList.remove('hidden'); }
}
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener('change', (e)=> setMode(e.target.value));
});
function clearTyping(){ typing.value=''; }

/* ---------- ูุณุงุญุฉ ุงููุณุฎ (Canvas + Pointer Events) ---------- */
const pad = document.getElementById('pad');
const ctx = pad.getContext('2d');

function fitCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio||1);
  const cssWidth = pad.clientWidth;
  const cssHeight = pad.clientHeight;
  pad.width = Math.floor(cssWidth * dpr);
  pad.height = Math.floor(cssHeight * dpr);
  ctx.setTransform(1,0,0,1,0,0);     // reset any existing scale
  ctx.scale(dpr, dpr);               // scale to CSS pixels
  ctx.lineCap = 'round'; ctx.lineJoin='round';
  ctx.lineWidth = 4; ctx.strokeStyle = '#111827';
  ctx.clearRect(0,0,cssWidth,cssHeight);
}
function clearPad(){ fitCanvas(); }
fitCanvas(); window.addEventListener('resize', fitCanvas);

/* Pointer events (ููุญุฏ ูููุงูุณ/ุงูููู/ุงูููุณ) */
let drawing = false, lastX=0, lastY=0;
function ppos(e){
  const r = pad.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;
  return {x,y};
}
pad.addEventListener('pointerdown', (e)=>{
  if(e.pointerType==='touch' || e.pointerType==='pen' || e.pointerType==='mouse'){
    drawing = true;
    const p = ppos(e); lastX=p.x; lastY=p.y;
    pad.setPointerCapture(e.pointerId);
    e.preventDefault();
  }
});
pad.addEventListener('pointermove', (e)=>{
  if(!drawing) return;
  const p = ppos(e);
  ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke();
  lastX=p.x; lastY=p.y;
  e.preventDefault();
});
pad.addEventListener('pointerup', (e)=>{ drawing=false; pad.releasePointerCapture(e.pointerId); e.preventDefault(); });
pad.addEventListener('pointercancel', ()=>{ drawing=false; });

document.getElementById('btnClearDraw').addEventListener('click', clearPad);

/* ---------- ุฅุถุงูุฉ ุจุทุงูุฉ ูู ููุชุงุญ ุงููุนููุฉ ---------- */
document.getElementById('btnAdd').addEventListener('click', ()=>{
  const w = document.getElementById('fWord').value.trim();
  const seg = document.getElementById('fSeg').value.trim();
  const sent = document.getElementById('fSent').value.trim();
  const level = Number(document.getElementById('fLevel').value);
  const domain = document.getElementById('fDomain').value;
  const skill = document.getElementById('fSkill').value;
  if(!w || !seg || !sent){ alert('ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู.'); return; }
  DATA.push({word:w, seg:seg, sentence:sent, domain, level, skill});
  saveData(DATA);
  updateCounts();
  alert('ุชูุช ุงูุฅุถุงูุฉ โ');
  document.getElementById('fWord').value=''; document.getElementById('fSeg').value=''; document.getElementById('fSent').value='';
});

/* ---------- ุชุตุฏูุฑ/ุงุณุชูุฑุงุฏ ---------- */
document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(DATA, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'iqra-cards.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
});
document.getElementById('fileImport').addEventListener('change', (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const arr = JSON.parse(r.result);
      if(!Array.isArray(arr)) throw 'bad';
      DATA = arr; saveData(DATA); updateCounts(); alert('ุชู ุงูุงุณุชูุฑุงุฏ โ');
    }catch{ alert('ููู ุบูุฑ ุตุงูุญ'); }
  };
  r.readAsText(file, 'utf-8');
});
document.getElementById('btnReset').addEventListener('click', ()=>{
  if(confirm('ุงุณุชุนุงุฏุฉ ูุฌููุนุฉ ุงูุจุฏุงูุฉุ ุณููุณุชุจุฏู ุฃู ุชุนุฏูู.')){
    DATA = [...DEFAULT_DATA]; saveData(DATA); updateCounts(); alert('ุชูุช ุงูุงุณุชุนุงุฏุฉ โ');
  }
});

/* ---------- ุฃุฒุฑุงุฑ ุนุงูุฉ ---------- */
updateCounts();
</script>
</body>
</html>
